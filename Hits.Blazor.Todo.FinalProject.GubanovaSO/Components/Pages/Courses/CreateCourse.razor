@page "/courses/create"
@page "/courses/edit/{Id:int}"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject CourseService courseService
@inject NavigationManager navigate
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(Id == 0 ? "Новый курс" : "Редактировать курс")</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="mb-4">@(Id == 0 ? "Создать новый курс" : "Редактировать курс")</h2>

            @if (loading)
            {
                <p>Загрузка...</p>
            }
            else if (course != null)
            {
                <EditForm Model="course" OnSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" />

                    <div class="mb-3">
                        <label class="form-label">Название курса *</label>
                        <InputText @bind-Value="course.Title" class="form-control" placeholder="Введи название" />
                        <ValidationMessage For="() => course.Title" class="invalid-feedback d-block" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Краткое описание *</label>
                        <InputTextArea @bind-Value="course.Description" class="form-control" rows="3" placeholder="Краткое описание курса" />
                        <ValidationMessage For="() => course.Description" class="invalid-feedback d-block" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Полное содержание *</label>
                        <InputTextArea @bind-Value="course.Content" class="form-control" rows="10" placeholder="Подробное содержание" />
                        <ValidationMessage For="() => course.Content" class="invalid-feedback d-block" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Категория *</label>
                        <InputText @bind-Value="course.Category" class="form-control" placeholder="Напр: Программирование" />
                        <ValidationMessage For="() => course.Category" class="invalid-feedback d-block" />
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Часов (1–1000) *</label>
                                <InputNumber @bind-Value="course.DurationHours" class="form-control" min="1" max="1000" />
                                <ValidationMessage For="() => course.DurationHours" class="invalid-feedback d-block" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Уровень сложности (1–3) *</label>
                                <InputNumber @bind-Value="course.DifficultyLevel" class="form-control" min="1" max="3" />
                                <ValidationMessage For="() => course.DifficultyLevel" class="invalid-feedback d-block" />
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            @(Id == 0 ? "Создать курс" : "Сохранить изменения")
                        </button>
                        <a href="/courses" class="btn btn-secondary">Отмена</a>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    Course course = new();
    bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(userId))
        {
            navigate.NavigateTo("/login");
            return;
        }

        if (Id == 0)
        {
            course = new Course
            {
                CreatedDate = DateTime.UtcNow,
                InstructorId = userId,
                DurationHours = 1,
                DifficultyLevel = 1,
                IsActive = true
            };
        }
        else
        {
            var existingCourse = await courseService.GetCourseByIdAsync(Id);
            if (existingCourse != null)
            {
                course = existingCourse;
            }
        }

        loading = false;
    }

    private async Task HandleSubmit()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                navigate.NavigateTo("/login");
                return;
            }

            course.InstructorId = userId;

            if (Id == 0)
            {
                course.CreatedDate = DateTime.UtcNow;
                course.IsActive = true;
                await courseService.CreateCourseAsync(course);
            }
            else
            {
                course.UpdatedDate = DateTime.UtcNow;
                await courseService.UpdateCourseAsync(course);
            }

            navigate.NavigateTo("/courses");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка: {ex.Message}");
        }
    }
}
