@page "/courses/create"
@page "/courses/edit/{Id:int}"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject CourseService courseService
@inject NavigationManager navigate
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (CourseItem != null)
{
    <EditForm Model="CourseItem" FormName="CourseForm" OnValidSubmit="ValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <h2>@(Id == 0 ? "Новый курс" : "Редактировать курс")</h2>

        <InputNumber @bind-Value="CourseItem.Id" hidden />

        <div class="form-group m-2">
            <label class="form-label">Название</label>
            <InputText @bind-Value="CourseItem.Title" class="form-control" />
            <ValidationMessage For="() => CourseItem.Title" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">Описание</label>
            <InputTextArea @bind-Value="CourseItem.Description" class="form-control" rows="3" />
            <ValidationMessage For="() => CourseItem.Description" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">Содержание курса</label>
            <InputTextArea @bind-Value="CourseItem.Content" class="form-control" rows="10" />
            <ValidationMessage For="() => CourseItem.Content" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">Категория</label>
            <InputText @bind-Value="CourseItem.Category" class="form-control" />
            <ValidationMessage For="() => CourseItem.Category" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">Часов (1-1000)</label>
            <InputNumber @bind-Value="CourseItem.DurationHours" class="form-control" min="1" max="1000" />
            <ValidationMessage For="() => CourseItem.DurationHours" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">Уровень (1-3)</label>
            <InputNumber @bind-Value="CourseItem.DifficultyLevel" class="form-control" min="1" max="3" />
            <ValidationMessage For="() => CourseItem.DifficultyLevel" />
        </div>

        <div class="form-group m-2">
            <label class="form-label">URL картинки</label>
            <InputText @bind-Value="CourseItem.ImageUrl" class="form-control" />
        </div>

        <div class="btn-group">
            <button class="btn btn-primary m-2" type="submit">Сохранить</button>
            <a class="btn btn-primary m-2" href="/courses">Отмена</a>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    Course? CourseItem { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

        if (CourseItem == null)
        {
            CourseItem = new Course
            {
                CreatedDate = DateTime.UtcNow,
                InstructorId = userId,
                DurationHours = 1,
                DifficultyLevel = 1
            };

            if (Id != 0)
            {
                var course = await courseService.GetCourseByIdAsync(Id);
                if (course != null)
                {
                    CourseItem.Id = course.Id;
                    CourseItem.Title = course.Title;
                    CourseItem.Description = course.Description;
                    CourseItem.Content = course.Content;
                    CourseItem.Category = course.Category;
                    CourseItem.DurationHours = course.DurationHours;
                    CourseItem.DifficultyLevel = course.DifficultyLevel;
                    CourseItem.ImageUrl = course.ImageUrl;
                    CourseItem.CreatedDate = course.CreatedDate;
                    CourseItem.InstructorId = course.InstructorId;
                }
            }
        }
    }

    async Task ValidSubmit()
    {
        if (CourseItem != null)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";

            if (Id == 0)
            {
                CourseItem.CreatedDate = DateTime.UtcNow;
                CourseItem.InstructorId = userId;
                await courseService.CreateCourseAsync(CourseItem);
            }
            else
            {
                CourseItem.UpdatedDate = DateTime.UtcNow;
                await courseService.UpdateCourseAsync(CourseItem);
            }
            navigate.NavigateTo("/courses");
        }
    }
}
