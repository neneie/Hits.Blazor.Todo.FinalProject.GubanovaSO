@page "/courses/create"

@inject CourseService CourseService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Создать курс</PageTitle>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <h2>Создать новый курс</h2>
            <hr />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            <EditForm FormName="createCourse" Model="Input" OnValidSubmit="HandleCreateCourse">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label class="form-label">Название курса</label>
                    <InputText @bind-Value="Input.Title" class="form-control" />
                    <ValidationMessage For="() => Input.Title" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Описание</label>
                    <InputTextArea @bind-Value="Input.Description" class="form-control" rows="5" />
                    <ValidationMessage For="() => Input.Description" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Категория</label>
                    <InputText @bind-Value="Input.Category" class="form-control" />
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Уровень сложности</label>
                            <InputSelect @bind-Value="Input.DifficultyLevel" class="form-control">
                                <option value="1">Начинающий</option>
                                <option value="2">Средний</option>
                                <option value="3">Продвинутый</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Длительность (часов)</label>
                            <InputNumber @bind-Value="Input.DurationHours" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="mb-3 form-check">
                    <InputCheckbox @bind-Value="Input.IsActive" class="form-check-input" id="isActive" />
                    <label class="form-check-label" for="isActive">Активный курс</label>
                </div>

                <button type="submit" class="btn btn-success">Создать курс</button>
                <a href="/courses" class="btn btn-secondary">Отмена</a>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private string? errorMessage;

    [SupplyParameterFromForm(FormName = "createCourse")]
    public InputModel Input { get; set; } = new();

    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private async Task HandleCreateCourse()
    {
        try
        {
            var userId = HttpContext?.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Ошибка: не удалось определить пользователя";
                return;
            }

            var course = new Course
            {
                Title = Input.Title,
                Description = Input.Description,
                Category = Input.Category ?? "",
                DifficultyLevel = Input.DifficultyLevel,
                DurationHours = Input.DurationHours,
                InstructorId = userId,
                IsActive = Input.IsActive,
                CreatedDate = DateTime.UtcNow
            };

            await CourseService.CreateCourseAsync(course);
            NavigationManager.NavigateTo("/courses");
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка при создании курса: {ex.Message}";
        }
    }

    public class InputModel
    {
        [Required(ErrorMessage = "Название обязательно")]
        [StringLength(200, MinimumLength = 3, ErrorMessage = "Название должно быть от 3 до 200 символов")]
        public string Title { get; set; } = "";

        [Required(ErrorMessage = "Описание обязательно")]
        [StringLength(2000, MinimumLength = 10, ErrorMessage = "Описание должно быть от 10 до 2000 символов")]
        public string Description { get; set; } = "";

        public string? Category { get; set; }

        [Range(1, 3, ErrorMessage = "Выберите уровень сложности")]
        public int DifficultyLevel { get; set; } = 1;

        [Range(1, 1000, ErrorMessage = "Длительность должна быть от 1 до 1000 часов")]
        public int DurationHours { get; set; } = 1;

        public bool IsActive { get; set; } = true;
    }
}
