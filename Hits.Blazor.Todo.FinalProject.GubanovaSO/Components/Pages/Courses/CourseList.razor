@page "/courses"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@inject CourseService CourseService

<PageTitle>Лекции - Образовательная платформа</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Все лекции</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Поиск..." @oninput="OnSearchChanged" />
        </div>
    </div>

    @if (filteredCourses == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
        </div>
    }
    else if (filteredCourses.Count == 0)
    {
        <div class="alert alert-info">Курсы не найдены</div>
    }
    else
    {
        <div class="row">
            @foreach (var course in filteredCourses)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">@course.Title</h5>
                            <p class="card-text small text-muted">@course.Category</p>
                            <p class="card-text">@(course.Description.Length > 100 ? course.Description.Substring(0, 100) + "..." : course.Description)</p>
                            <p class="small text-muted">Уроков: @course.Lessons.Count</p>
                            <a href="/courses/@course.Id" class="btn btn-primary w-100">Подробнее</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Course>? allCourses;
    private List<Course>? filteredCourses;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            allCourses = await CourseService.GetAllCoursesAsync();
            filteredCourses = allCourses;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка: {ex.Message}");
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        FilterCourses();
    }

    private void FilterCourses()
    {
        if (allCourses == null) return;

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredCourses = allCourses;
        }
        else
        {
            var term = searchTerm.ToLower();
            filteredCourses = allCourses
                .Where(c => c.Title.ToLower().Contains(term) || c.Description.ToLower().Contains(term))
                .ToList();
        }
    }
}
