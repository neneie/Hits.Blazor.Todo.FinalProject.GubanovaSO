@page "/courses"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@using Microsoft.AspNetCore.Authorization
@inject CourseService CourseService
@inject NavigationManager Navigation

<PageTitle>Courses - Hits.Todo</PageTitle>

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>All Courses</h1>
            <p class="text-muted">Choose an interesting course and start learning</p>
        </div>
        <div class="col-md-4">
            <AuthorizeView Roles="Instructor,Admin">
                <Authorized>
                    <a href="/courses/create" class="btn btn-success btn-lg w-100">
                        Create Course
                    </a>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>

    <div class="mb-3">
        <input type="text" 
               class="form-control form-control-lg" 
               placeholder="Search courses..." 
               @oninput="SearchCourses" />
    </div>

    @if (courses == null)
    {
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm me-2"></span>
            Loading courses...
        </div>
    }
    else if (courses.Count == 0)
    {
        <div class="alert alert-warning">
            No courses found. Try changing your search query.
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var course in courses)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm course-card">
                        @if (!string.IsNullOrEmpty(course.ImageUrl))
                        {
                            <img src="@course.ImageUrl" class="card-img-top" alt="@course.Title" style="height: 200px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                <span class="text-white">No Image</span>
                            </div>
                        }
                        
                        <div class="card-body">
                            <h5 class="card-title">@course.Title</h5>
                            <p class="card-text text-muted">
                                @if (course.Description.Length > 100)
                                {
                                    @(course.Description.Substring(0, 100) + "...")
                                }
                                else
                                {
                                    @course.Description
                                }
                            </p>
                            
                            <div class="mb-3">
                                <span class="badge bg-primary">@GetDifficultyLevel(course.DifficultyLevel)</span>
                                <span class="badge bg-info">@course.DurationHours hours</span>
                                <span class="badge bg-secondary">@course.Lessons.Count lessons</span>
                            </div>
                        </div>

                        <div class="card-footer bg-white border-top">
                            <a href="/courses/@course.Id" class="btn btn-primary w-100">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .course-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important;
    }
</style>

@code {
    private List<Course>? courses;
    private List<Course>? allCourses;

    protected override async Task OnInitializedAsync()
    {
        await LoadCourses();
    }

    private async Task LoadCourses()
    {
        courses = null;
        allCourses = await CourseService.GetAllCoursesAsync();
        courses = allCourses;
    }

    private async Task SearchCourses(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            courses = allCourses;
        }
        else
        {
            courses = await CourseService.SearchCoursesAsync(searchTerm);
        }
    }

    private string GetDifficultyLevel(int level)
    {
        return level switch
        {
            1 => "Beginner",
            2 => "Intermediate",
            3 => "Advanced",
            _ => "Unknown"
        };
    }
}
