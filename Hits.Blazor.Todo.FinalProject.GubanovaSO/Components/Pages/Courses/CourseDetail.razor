@page "/courses/{CourseId:int}"
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Models
@using Hits.Blazor.Todo.FinalProject.GubanovaSO.Data.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject CourseService CourseService
@inject EnrollmentService EnrollmentService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="container mt-4">
    @if (course == null)
    {
        <p>Загрузка...</p>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <h1>@course.Title</h1>
                <p class="text-muted">
                    <strong>Категория:</strong> @course.Category |
                    <strong>Часов:</strong> @course.DurationHours |
                    <strong>Уровень:</strong> @course.DifficultyLevel
                </p>

                <h3>Описание</h3>
                <p>@course.Description</p>

                <h3>Полное содержание</h3>
                @if (!string.IsNullOrEmpty(course.Content))
                {
                    <p>@course.Content</p>
                }
                else
                {
                    <p class="text-muted">Содержание не заполнено</p>
                }
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Действия</h5>
                    </div>
                    <div class="card-body">
                        <AuthorizeView>
                            <Authorized>
                                @if (!isEnrolled)
                                {
                                    <button class="btn btn-success w-100 mb-2" @onclick="EnrollCourse">
                                        Записаться
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-danger w-100 mb-2" @onclick="UnrollCourse">
                                        Отписаться
                                    </button>
                                    <div class="alert alert-info">
                                        <strong>Прогресс:</strong> @progressPercentage%
                                    </div>
                                }
                            </Authorized>
                            <NotAuthorized>
                                <p class="alert alert-warning">
                                    Для записи на курс <a href="/login">войдите в аккаунт</a>
                                </p>
                            </NotAuthorized>
                        </AuthorizeView>

                        <hr />

                        <a class="btn btn-secondary w-100" href="/courses">Вернуться к курсам</a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int CourseId { get; set; }

    Course? course;
    bool isEnrolled = false;
    int progressPercentage = 0;
    Enrollment? currentEnrollment;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        course = await CourseService.GetCourseByIdAsync(CourseId);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                currentEnrollment = await EnrollmentService.GetEnrollmentAsync(userId, CourseId);
                if (currentEnrollment != null)
                {
                    isEnrolled = true;
                    progressPercentage = currentEnrollment.ProgressPercentage;
                }
            }
        }
    }

    async Task EnrollCourse()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            await EnrollmentService.EnrollUserAsync(userId, CourseId);
            isEnrolled = true;
            currentEnrollment = await EnrollmentService.GetEnrollmentAsync(userId, CourseId);
        }
    }

    async Task UnrollCourse()
    {
        if (currentEnrollment == null) return;

        await EnrollmentService.DeleteEnrollmentAsync(currentEnrollment.Id);
        isEnrolled = false;
        progressPercentage = 0;
        currentEnrollment = null;
    }
}
